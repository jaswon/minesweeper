<html>
    <head>
        <title>minesueeepuruuuuu</title>
        <link rel="stylesheet" type="text/css" href="main.css">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    </head>
    <body>
        <div class="game-container">
            <table id="game"></table>
            <span id="lives"></span>
            <span id="score"></span>
        </div>
        <div class="instructions">
            Click on a tile to test it. <br>
            Shift-click to flag it as a mine. <br>
            If you trigger a mine, you lose a life. <br>
            If you successfully flag all mines before losing all five lives, you win! <br>
        </div>
    </body>
    <script charset="utf-8">
        //CONSTANTS
        var w = 15;
        var h = 15;
        var MAX_LIVES = 5;
        var lives = MAX_LIVES;
        var score = 0;

        // lower = easier
        var difficulty = Math.max(Math.min(parseInt(prompt("Difficulty? (1-99)","1"),10) || 1,99),1)*.01;

        var size = Math.max(Math.min( parseInt(prompt("Board size? (10-30)","15")) || 15, 30 ), 10)

        w = size
        h = size

        //starting at down, ccw
        var dir = [[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]]

        //get board display
        var tbl = document.getElementById("game");

        //initialize board
        var board;

        var resetBoard = function() {
            board = [];
            for (var i = 0 ; i < h ; i++) {
                var row = [];
                for (var j = 0 ; j < w ; j++) {
                    row[j] = Math.random()<difficulty?1:0;
                }
                board[i] = row;
            }
            tbl.innerHTML = "";
            for (var i = 0 ; i < h ; i++) {
                var tr = tbl.insertRow();
                for(var j = 0 ; j < w ; j++){
                    var td = tr.insertCell();
                    td.className = "block " + (board[i][j]?"mine":"safe");
                }
            }

            //flag blocks as bombs
            $('.block').click(function(ev) {
                if (ev.shiftKey) $(ev.target).toggleClass('flag');
                var done = true;
                $('.mine').each(function(index, el) {
                    if (!$(el).hasClass('flag')) done = false;
                })
                if (done) {
                    alert("minefield cleared!");
                    score++;
                    $("#score").html(score)
                    resetBoard();
                }
            })

            $('.safe').click(function(ev) {
                if (!ev.shiftKey) check(ev.target);
            })

            $('.mine').click(function(ev) {
                if (!ev.shiftKey) {
                    lives--;
                    if (0 == lives) {
                        alert("you died lol. you cleared " + score + " minefields.");
                        resetBoard();
                        lives = MAX_LIVES;
                    }
                    $("#lives").html("&#9829;".repeat(lives))
                }
            })
        }

        var check = function(cell) {
            var sum = 0;
            dir.forEach(function(mod) {
                if (board[cell.parentNode.rowIndex+mod[0]]) {
                    sum += board[cell.parentNode.rowIndex+mod[0]][cell.cellIndex+mod[1]] || 0;
                }
            })
            cell.className = "block clicked";
            if (0 == sum) {
                var adj_cell;
                dir.forEach(function(mod) {
                    if (adj_cell = getCell(cell.parentNode.rowIndex+mod[0],cell.cellIndex+mod[1])) {
                        if (!$(adj_cell).hasClass("clicked")) {
                            check(adj_cell);
                        }
                    }
                })
            } else {
                cell.innerHTML = sum;
            }
        }

        var getCell = function(i,j) {
            if (tbl.rows.item(i)) {
                return tbl.rows.item(i).cells.item(j);
            } else {
                return null;
            }
        }

        resetBoard();

        $("#lives").html("&#9829;".repeat(lives))
        $("#score").text(score)
    </script>
</html>
